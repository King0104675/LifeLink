{% extends "base.html" %}

{% block title %}Active Requests - LifeLink{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-list-alt me-2 text-danger"></i>Active Donation Requests
                </h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="filterRequests('all')">
                        <i class="fas fa-list me-1"></i>All
                    </button>
                    <button class="btn btn-outline-danger" onclick="filterRequests('blood')">
                        <i class="fas fa-tint me-1"></i>Blood
                    </button>
                    <button class="btn btn-outline-warning" onclick="filterRequests('organ')">
                        <i class="fas fa-heart me-1"></i>Organs
                    </button>
                    <button class="btn btn-outline-success" onclick="filterRequests('critical')">
                        <i class="fas fa-exclamation-triangle me-1"></i>Critical
                    </button>
                </div>
            </div>

            {% if requests %}
                <div class="row g-4">
                    {% for request_id, request in requests.items() %}
                        <div class="col-lg-6 col-xl-4 request-card" data-type="{{ request.type }}" data-urgency="{{ request.urgency }}">
                            <div class="card h-100 fade-in {{ 'border-danger' if request.urgency == 'critical' else 'border-warning' if request.urgency == 'urgent' else '' }}">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{{ 'tint text-danger' if request.type == 'blood' else 'heart text-warning' }} fa-lg me-2"></i>
                                        <h6 class="mb-0 fw-bold">{{ request.type|title }} Request</h6>
                                    </div>
                                    <span class="urgent-badge {{ 'bg-danger' if request.urgency == 'critical' else 'bg-warning' if request.urgency == 'urgent' else 'bg-info' }}">
                                        {{ request.urgency|title }}
                                    </span>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="text-primary mb-2">Patient Information</h6>
                                        <div class="small">
                                            <div class="mb-1"><strong>Patient:</strong> {{ request.patient_name }}</div>
                                            <div class="mb-1"><strong>Contact:</strong> {{ request.contact_person }}</div>
                                            <div class="mb-1"><strong>Phone:</strong> 
                                                <a href="tel:{{ request.phone }}" class="text-decoration-none">{{ request.phone }}</a>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <h6 class="text-primary mb-2">Requirements</h6>
                                        {% if request.type == 'blood' %}
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge bg-danger me-2">{{ request.blood_group }}</span>
                                                <span class="small">{{ request.quantity }} Unit(s)</span>
                                            </div>
                                        {% else %}
                                            <div class="small mb-2">
                                                <i class="fas fa-heart me-1 text-danger"></i>{{ request.organ }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-3">
                                        <h6 class="text-primary mb-2">Location</h6>
                                        <div class="small">
                                            <div class="mb-1">
                                                <i class="fas fa-map-marker-alt me-1 text-muted"></i>{{ request.city }}
                                            </div>
                                            <div class="mb-1">
                                                <i class="fas fa-hospital me-1 text-muted"></i>{{ request.hospital }}
                                            </div>
                                            <div class="mb-1">
                                                <i class="fas fa-search-location me-1 text-muted"></i>{{ request.max_distance }}km radius
                                            </div>
                                        </div>
                                    </div>

                                    {% if request.additional_info %}
                                    <div class="mb-3">
                                        <h6 class="text-primary mb-2">Additional Info</h6>
                                        <div class="small text-muted bg-light p-2 rounded">
                                            {{ request.additional_info[:100] }}
                                            {% if request.additional_info|length > 100 %}...{% endif %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>{{ request.created_date[:19] }}
                                            </small>
                                            <span class="badge bg-{{ 'success' if request.status == 'matched' else 'primary' if request.status == 'active' else 'secondary' }}">
                                                {{ request.status|title }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <a href="{{ url_for('request_status', request_id=request_id) }}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye me-1"></i>View Details
                                        </a>
                                        <a href="tel:{{ request.phone }}" class="btn btn-success btn-sm">
                                            <i class="fas fa-phone me-1"></i>Call Now
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Load More Button -->
                <div class="text-center mt-5" id="loadMore" style="display: none;">
                    <button class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>Load More Requests
                    </button>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <div class="card">
                        <div class="card-body py-5">
                            <i class="fas fa-clipboard-list fa-4x text-muted mb-4"></i>
                            <h4 class="text-muted mb-3">No Active Requests</h4>
                            <p class="text-muted mb-4">There are currently no donation requests. Check back later or help spread the word about LifeLink.</p>
                            <div class="d-flex justify-content-center gap-3">
                                <a href="{{ url_for('request_donation') }}" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Submit New Request
                                </a>
                                <a href="{{ url_for('register') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-user-plus me-2"></i>Register as Donor
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Statistics Bar -->
<div class="bg-primary text-white py-4 mt-5">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-3 col-6 mb-2">
                <div class="fw-bold fs-4">{{ requests|length }}</div>
                <div class="small">Total Requests</div>
            </div>
            <div class="col-md-3 col-6 mb-2">
                <div class="fw-bold fs-4">{{ requests.values()|selectattr("urgency", "equalto", "critical")|list|length }}</div>
                <div class="small">Critical Cases</div>
            </div>
            <div class="col-md-3 col-6 mb-2">
                <div class="fw-bold fs-4">{{ requests.values()|selectattr("type", "equalto", "blood")|list|length }}</div>
                <div class="small">Blood Requests</div>
            </div>
            <div class="col-md-3 col-6 mb-2">
                <div class="fw-bold fs-4">{{ requests.values()|selectattr("type", "equalto", "organ")|list|length }}</div>
                <div class="small">Organ Requests</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterRequests(filter) {
    const cards = document.querySelectorAll('.request-card');

    cards.forEach(card => {
        const type = card.getAttribute('data-type');
        const urgency = card.getAttribute('data-urgency');

        let show = false;

        switch(filter) {
            case 'all':
                show = true;
                break;
            case 'blood':
                show = type === 'blood';
                break;
            case 'organ':
                show = type === 'organ';
                break;
            case 'critical':
                show = urgency === 'critical';
                break;
        }

        if (show) {
            card.style.display = 'block';
            card.classList.add('fade-in');
        } else {
            card.style.display = 'none';
        }
    });

    // Update active button
    document.querySelectorAll('.btn-outline-primary, .btn-outline-danger, .btn-outline-warning, .btn-outline-success').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Auto-refresh every 2 minutes
setInterval(() => {
    location.reload();
}, 120000);

// Initialize with all requests
filterRequests('all');
</script>
{% endblock %}